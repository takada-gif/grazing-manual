<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š çµŒå–¶åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #4facfe;
        }

        .input-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .input-group textarea {
            height: 120px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .btn.success {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .btn.warning {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .summary-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-card .change {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #e1e5e9;
        }

        .chart-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .alert-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .alert-section h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .alert-item {
            background: white;
            border-left: 4px solid #ff6b6b;
            padding: 12px 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .alert-item.warning {
            border-left-color: #ffc107;
        }

        .alert-item.danger {
            border-left-color: #dc3545;
        }

        .alert-item.success {
            border-left-color: #28a745;
        }

        .alert-item h4 {
            margin: 0 0 5px 0;
            font-size: 1em;
            color: #333;
        }

        .alert-item p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .success {
            background: #51cf66;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š çµŒå–¶åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>å£²ä¸Šãƒ»åˆ©ç›Šãƒ»çµŒè²»ã®åŒ…æ‹¬çš„ãªåˆ†æã¨å¯è¦–åŒ–</p>
        </div>

        <div class="content">
            <!-- ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="input-section">
                <h2>ğŸ“„ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                
                <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                <div class="input-group">
                    <label for="csvFile">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼š</label>
                    <input type="file" id="csvFile" accept=".csv,.xlsx,.xls" onchange="DataProcessor.handleFileUpload(event)" style="padding: 8px; border: 2px solid #e1e5e9; border-radius: 8px; width: 100%;">
                    <div id="fileInfo" style="margin-top: 10px; font-size: 0.9em; color: #666;"></div>
                </div>
                
                <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› -->
                <div class="input-group">
                    <label for="dataInput">ã¾ãŸã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§å…¥åŠ›ï¼š</label>
                    <textarea id="dataInput" placeholder="ä¾‹ï¼š
2025å¹´6æœˆ: å˜æœˆå®Ÿç¸¾ 274,890,000å††, ç´¯è¨ˆå®Ÿç¸¾ 766,174,000å††, åˆ©ç›Š 50,000,000å††
2025å¹´7æœˆ: å˜æœˆå®Ÿç¸¾ 300,000,000å††, ç´¯è¨ˆå®Ÿç¸¾ 1,066,174,000å††, åˆ©ç›Š 60,000,000å††
..."></textarea>
                </div>
                
                <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
                <button class="btn" onclick="Dashboard.processData()">ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æãƒ»å¯è¦–åŒ–</button>
                <button class="btn secondary" onclick="DataProcessor.loadSampleData()">ğŸ¯ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§è©¦ã™</button>
                <button class="btn success" onclick="DataProcessor.loadCSVData()">ğŸ“Š CSVãƒ‡ãƒ¼ã‚¿ã§å¯è¦–åŒ–</button>
                <button class="btn warning" onclick="EmailService.shareByEmail()">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã§å…±æœ‰</button>
            </div>

            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
            <div class="error" id="errorMessage"></div>
            <div class="success" id="successMessage"></div>
            <div class="alert-section" id="alertSection">
                <h3>ğŸš¨ åˆ†æçµæœã¨ã‚¢ãƒ©ãƒ¼ãƒˆ</h3>
                <div id="alertContainer"></div>
            </div>

            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="summary-cards" id="summaryCards" style="display: none;">
                <div class="summary-card">
                    <h4>ç·å£²ä¸Š</h4>
                    <div class="value" id="totalRevenue">Â¥0</div>
                    <div class="change">ç´¯è¨ˆ</div>
                </div>
                <div class="summary-card">
                    <h4>å‰æœˆå£²ä¸Š</h4>
                    <div class="value" id="lastMonthRevenue">Â¥0</div>
                    <div class="change">å‰æœˆå®Ÿç¸¾</div>
                </div>
                <div class="summary-card">
                    <h4>å‰æœˆç´¯è¨ˆå£²ä¸Š</h4>
                    <div class="value" id="lastMonthCumulative">Â¥0</div>
                    <div class="change">å‰æœˆã¾ã§ã®ç´¯è¨ˆ</div>
                </div>
                <div class="summary-card">
                    <h4>å¹³å‡ç²—åˆ©ç‡</h4>
                    <div class="value" id="avgGrossMargin">0%</div>
                    <div class="change">æœˆå¹³å‡</div>
                </div>
                <div class="summary-card">
                    <h4>ç´¯è¨ˆå–¶æ¥­åˆ©ç›Š</h4>
                    <div class="value" id="totalOperatingProfit">Â¥0</div>
                    <div class="change">ç´¯è¨ˆé¡</div>
                </div>
                <div class="summary-card">
                    <h4>ç´¯è¨ˆå–¶æ¥­åˆ©ç›Šç‡</h4>
                    <div class="value" id="totalOperatingMargin">0%</div>
                    <div class="change">ç´¯è¨ˆç‡</div>
                </div>
                <div class="summary-card">
                    <h4>å‰æœˆå–¶æ¥­åˆ©ç›Š</h4>
                    <div class="value" id="lastMonthOperatingProfit">Â¥0</div>
                    <div class="change">å‰æœˆå®Ÿç¸¾</div>
                </div>
                <div class="summary-card">
                    <h4>å‰æœˆå–¶æ¥­åˆ©ç›Šç‡</h4>
                    <div class="value" id="lastMonthOperatingMargin">0%</div>
                    <div class="change">å‰æœˆç‡</div>
                </div>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="charts-container" id="chartsContainer" style="display: none;">
                <div class="chart-card">
                    <h3>ğŸ“ˆ æœˆåˆ¥å£²ä¸Šæ¨ç§»</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ’° æœˆåˆ¥åˆ©ç›Šç‡æ¨ç§»</h3>
                    <div class="chart-container">
                        <canvas id="marginChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ“Š å£²ä¸Š vs äºˆç®—</h3>
                    <div class="chart-container">
                        <canvas id="budgetChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ¯ äºˆç®—é”æˆç‡</h3>
                    <div class="chart-container">
                        <canvas id="achievementChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ’¸ ãƒˆãƒƒãƒ—5çµŒè²»æ¨ç§»</h3>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ“Š çµŒè²»æ§‹æˆæ¯”</h3>
                    <div class="chart-container">
                        <canvas id="expensePieChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ“Š ç²—åˆ©ç‡æ¨ç§»</h3>
                    <div class="chart-container">
                        <canvas id="grossMarginChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>ğŸ’° å–¶æ¥­åˆ©ç›Šæ¨ç§»</h3>
                    <div class="chart-container">
                        <canvas id="operatingProfitChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentData = null;
        let charts = {};

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        const MessageUtils = {
            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            },

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }
        };

        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¯ãƒ©ã‚¹
        const DataProcessor = {
            parseData(text) {
                const lines = text.split('\n').filter(line => line.trim());
                const data = [];
                
                for (const line of lines) {
                    const patterns = [
                        // å˜æœˆå®Ÿç¸¾ãƒ»ç´¯è¨ˆå®Ÿç¸¾ãƒ»åˆ©ç›Šã®å½¢å¼
                        /(\d{4}å¹´?\s*\d{1,2}æœˆ?)[:ï¼š]\s*å˜æœˆå®Ÿç¸¾\s*([\d,]+)[å††]?\s*[,ã€]\s*ç´¯è¨ˆå®Ÿç¸¾\s*([\d,]+)[å††]?\s*[,ã€]\s*åˆ©ç›Š\s*([\d,]+)[å††]?/,
                        /(\d{4}å¹´?\s*\d{1,2}æœˆ?)[:ï¼š]\s*å˜æœˆå®Ÿç¸¾\s*([\d,]+)\s*[,ã€]\s*ç´¯è¨ˆå®Ÿç¸¾\s*([\d,]+)\s*[,ã€]\s*åˆ©ç›Š\s*([\d,]+)/,
                        // å¾“æ¥ã®å£²ä¸Šãƒ»åˆ©ç›Šãƒ»äºˆç®—ã®å½¢å¼
                        /(\d{4}å¹´?\s*\d{1,2}æœˆ?)[:ï¼š]\s*å£²ä¸Š\s*([\d,]+)[å††]?\s*[,ã€]\s*åˆ©ç›Š\s*([\d,]+)[å††]?\s*[,ã€]\s*äºˆç®—\s*([\d,]+)[å††]?/,
                        /(\d{4}å¹´?\s*\d{1,2}æœˆ?)[:ï¼š]\s*å£²ä¸Š\s*([\d,]+)\s*[,ã€]\s*åˆ©ç›Š\s*([\d,]+)\s*[,ã€]\s*äºˆç®—\s*([\d,]+)/,
                        // äºˆç®—ãªã—ã®å ´åˆ
                        /(\d{4}å¹´?\s*\d{1,2}æœˆ?)[:ï¼š]\s*å£²ä¸Š\s*([\d,]+)[å††]?\s*[,ã€]\s*åˆ©ç›Š\s*([\d,]+)[å††]?/,
                        /(\d{4}å¹´?\s*\d{1,2}æœˆ?)[:ï¼š]\s*å£²ä¸Š\s*([\d,]+)\s*[,ã€]\s*åˆ©ç›Š\s*([\d,]+)/
                    ];
                    
                    let match = null;
                    for (const pattern of patterns) {
                        match = line.match(pattern);
                        if (match) break;
                    }
                    
                    if (match) {
                        const month = match[1];
                        let revenue, profit, budget = null;
                        
                        if (line.includes('å˜æœˆå®Ÿç¸¾') && line.includes('ç´¯è¨ˆå®Ÿç¸¾')) {
                            revenue = parseInt(match[2].replace(/,/g, ''));
                            profit = parseInt(match[4].replace(/,/g, ''));
                        } else {
                            revenue = parseInt(match[2].replace(/,/g, ''));
                            profit = parseInt(match[3].replace(/,/g, ''));
                            budget = match[4] ? parseInt(match[4].replace(/,/g, '')) : null;
                        }
                        
                        const margin = (profit / revenue * 100).toFixed(1);
                        const budgetAchievement = budget ? ((revenue / budget * 100).toFixed(1)) : null;
                        
                        data.push({
                            month: month,
                            revenue: revenue,
                            profit: profit,
                            budget: budget,
                            margin: parseFloat(margin),
                            budgetAchievement: budgetAchievement ? parseFloat(budgetAchievement) : null
                        });
                    }
                }
                
                return data;
            },

            loadSampleData() {
                const sampleData = `2025å¹´1æœˆ: å£²ä¸Š 1,000,000å††, åˆ©ç›Š 200,000å††, äºˆç®— 950,000å††
2025å¹´2æœˆ: å£²ä¸Š 1,200,000å††, åˆ©ç›Š 250,000å††, äºˆç®— 1,100,000å††
2025å¹´3æœˆ: å£²ä¸Š 1,100,000å††, åˆ©ç›Š 220,000å††, äºˆç®— 1,000,000å††
2025å¹´4æœˆ: å£²ä¸Š 1,350,000å††, åˆ©ç›Š 280,000å††, äºˆç®— 1,300,000å††
2025å¹´5æœˆ: å£²ä¸Š 1,500,000å††, åˆ©ç›Š 320,000å††, äºˆç®— 1,400,000å††
2025å¹´6æœˆ: å£²ä¸Š 1,400,000å††, åˆ©ç›Š 300,000å††, äºˆç®— 1,350,000å††`;
                
                document.getElementById('dataInput').value = sampleData;
                MessageUtils.showSuccess('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
            },

            loadCSVData() {
                const csvData = `2025å¹´6æœˆ: å˜æœˆå®Ÿç¸¾ 274,890,000å††, ç´¯è¨ˆå®Ÿç¸¾ 766,174,000å††, åˆ©ç›Š 50,000,000å††
2025å¹´7æœˆ: å˜æœˆå®Ÿç¸¾ 300,000,000å††, ç´¯è¨ˆå®Ÿç¸¾ 1,066,174,000å††, åˆ©ç›Š 60,000,000å††
2025å¹´8æœˆ: å˜æœˆå®Ÿç¸¾ 350,000,000å††, ç´¯è¨ˆå®Ÿç¸¾ 1,416,174,000å††, åˆ©ç›Š 70,000,000å††
2025å¹´9æœˆ: å˜æœˆå®Ÿç¸¾ 400,000,000å††, ç´¯è¨ˆå®Ÿç¸¾ 1,816,174,000å††, åˆ©ç›Š 80,000,000å††
2025å¹´10æœˆ: å˜æœˆå®Ÿç¸¾ 450,000,000å††, ç´¯è¨ˆå®Ÿç¸¾ 2,266,174,000å††, åˆ©ç›Š 90,000,000å††`;
                
                document.getElementById('dataInput').value = csvData;
                MessageUtils.showSuccess('CSVãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ï¼ˆå˜æœˆå®Ÿç¸¾ãƒ»ç´¯è¨ˆå®Ÿç¸¾ï¼‰');
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = `ğŸ“ é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const data = DataProcessor.parseData(content);
                        
                        if (data.length > 0) {
                            MessageUtils.showSuccess(`CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼${data.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚`);
                            setTimeout(() => {
                                Dashboard.visualizeData(data);
                            }, 500);
                        } else {
                            MessageUtils.showError('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                        }
                    } catch (error) {
                        MessageUtils.showError('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    }
                };
                
                reader.readAsText(file, 'UTF-8');
            }
        };

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç®¡ç†ã‚¯ãƒ©ã‚¹
        const Dashboard = {
            processData() {
                const text = document.getElementById('dataInput').value.trim();
                
                if (!text) {
                    MessageUtils.showError('ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                try {
                    const data = DataProcessor.parseData(text);
                    
                    if (data.length === 0) {
                        MessageUtils.showError('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    MessageUtils.showSuccess(`${data.length}ãƒ¶æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—ã¾ã—ãŸï¼`);
                    this.visualizeData(data);
                    
                } catch (error) {
                    MessageUtils.showError('ãƒ‡ãƒ¼ã‚¿ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            },

            visualizeData(data) {
                currentData = data;
                
                // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã®æ›´æ–°
                this.updateSummaryCards(data);
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆã®æ¤œå‡º
                this.detectAnomalies(data);
                
                // ãƒãƒ£ãƒ¼ãƒˆã®ä½œæˆ
                ChartManager.createAllCharts(data);
                
                // è¡¨ç¤º
                document.getElementById('summaryCards').style.display = 'grid';
                document.getElementById('chartsContainer').style.display = 'grid';
            },

            updateSummaryCards(data) {
                const totalRevenue = data.reduce((sum, item) => sum + item.revenue, 0);
                const lastMonth = data[data.length - 1];
                const lastMonthRevenue = lastMonth ? lastMonth.revenue : 0;
                const lastMonthCumulative = data.length > 1 ? data.slice(0, -1).reduce((sum, item) => sum + item.revenue, 0) : 0;
                
                const avgGrossMargin = (data.reduce((sum, item) => sum + item.margin, 0) / data.length).toFixed(1);
                
                const totalOperatingProfit = data.reduce((sum, item) => {
                    const expenses = item.expenses ? Object.values(item.expenses).reduce((expSum, exp) => expSum + exp, 0) : 0;
                    return sum + (item.profit - expenses);
                }, 0);
                
                const totalOperatingMargin = totalRevenue > 0 ? ((totalOperatingProfit / totalRevenue) * 100).toFixed(1) : 0;
                
                const lastMonthExpenses = lastMonth && lastMonth.expenses ? 
                    Object.values(lastMonth.expenses).reduce((sum, exp) => sum + exp, 0) : 0;
                const lastMonthOperatingProfit = lastMonth ? (lastMonth.profit - lastMonthExpenses) : 0;
                const lastMonthOperatingMargin = lastMonthRevenue > 0 ? ((lastMonthOperatingProfit / lastMonthRevenue) * 100).toFixed(1) : 0;
                
                document.getElementById('totalRevenue').textContent = `Â¥${totalRevenue.toLocaleString()}`;
                document.getElementById('lastMonthRevenue').textContent = `Â¥${lastMonthRevenue.toLocaleString()}`;
                document.getElementById('lastMonthCumulative').textContent = `Â¥${lastMonthCumulative.toLocaleString()}`;
                document.getElementById('avgGrossMargin').textContent = `${avgGrossMargin}%`;
                document.getElementById('totalOperatingProfit').textContent = `Â¥${totalOperatingProfit.toLocaleString()}`;
                document.getElementById('totalOperatingMargin').textContent = `${totalOperatingMargin}%`;
                document.getElementById('lastMonthOperatingProfit').textContent = `Â¥${lastMonthOperatingProfit.toLocaleString()}`;
                document.getElementById('lastMonthOperatingMargin').textContent = `${lastMonthOperatingMargin}%`;
            },

            detectAnomalies(data) {
                const alerts = [];
                
                data.forEach(item => {
                    if (item.budgetAchievement !== null) {
                        if (item.budgetAchievement >= 150) {
                            alerts.push({
                                type: 'warning',
                                title: `ğŸš€ äºˆç®—å¤§å¹…è¶…é: ${item.month}`,
                                message: `äºˆç®—é”æˆç‡ãŒ${item.budgetAchievement}%ã¨ç•°å¸¸ã«é«˜ããªã£ã¦ã„ã¾ã™ã€‚`
                            });
                        } else if (item.budgetAchievement <= 50) {
                            alerts.push({
                                type: 'danger',
                                title: `âš ï¸ äºˆç®—å¤§å¹…æœªé”: ${item.month}`,
                                message: `äºˆç®—é”æˆç‡ãŒ${item.budgetAchievement}%ã¨ç•°å¸¸ã«ä½ããªã£ã¦ã„ã¾ã™ã€‚`
                            });
                        }
                    }
                    
                    if (item.margin < 0) {
                        alerts.push({
                            type: 'danger',
                            title: `ğŸ’¸ èµ¤å­—: ${item.month}`,
                            message: `åˆ©ç›Šç‡ãŒ${item.margin}%ã¨ãƒã‚¤ãƒŠã‚¹ã«ãªã£ã¦ã„ã¾ã™ã€‚`
                        });
                    }
                });
                
                this.displayAlerts(alerts);
            },

            displayAlerts(alerts) {
                const alertSection = document.getElementById('alertSection');
                const alertContainer = document.getElementById('alertContainer');
                
                if (alerts.length === 0) {
                    alertSection.style.display = 'none';
                    return;
                }
                
                alertContainer.innerHTML = '';
                alerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert-item ${alert.type}`;
                    alertDiv.innerHTML = `
                        <h4>${alert.title}</h4>
                        <p>${alert.message}</p>
                    `;
                    alertContainer.appendChild(alertDiv);
                });
                
                alertSection.style.display = 'block';
            }
        };

        // ãƒãƒ£ãƒ¼ãƒˆç®¡ç†ã‚¯ãƒ©ã‚¹
        const ChartManager = {
            createAllCharts(data) {
                const months = data.map(item => item.month);
                const revenues = data.map(item => item.revenue);
                const margins = data.map(item => item.margin);
                const budgets = data.map(item => item.budget || 0);
                const achievements = data.map(item => item.budgetAchievement || 0);
                
                this.createRevenueChart(months, revenues);
                this.createMarginChart(months, margins);
                this.createBudgetChart(months, revenues, budgets);
                this.createAchievementChart(months, achievements);
                this.createExpenseCharts(data);
                this.createGrossMarginChart(months, margins);
                this.createOperatingProfitChart(data);
            },

            createRevenueChart(months, revenues) {
                const ctx = document.getElementById('revenueChart').getContext('2d');
                if (charts.revenue) charts.revenue.destroy();
                
                charts.revenue = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'å£²ä¸Š (å††)',
                            data: revenues,
                            borderColor: '#4facfe',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#4facfe',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'Â¥' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            },

            createMarginChart(months, margins) {
                const ctx = document.getElementById('marginChart').getContext('2d');
                if (charts.margin) charts.margin.destroy();
                
                charts.margin = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'åˆ©ç›Šç‡ (%)',
                            data: margins,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            },

            createBudgetChart(months, revenues, budgets) {
                const ctx = document.getElementById('budgetChart').getContext('2d');
                if (charts.budget) charts.budget.destroy();
                
                charts.budget = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'å£²ä¸Š (å††)',
                            data: revenues,
                            backgroundColor: 'rgba(79, 172, 254, 0.8)',
                            borderColor: '#4facfe',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                        }, {
                            label: 'äºˆç®— (å††)',
                            data: budgets,
                            backgroundColor: 'rgba(255, 193, 7, 0.8)',
                            borderColor: '#ffc107',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'top' } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'Â¥' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            },

            createAchievementChart(months, achievements) {
                const ctx = document.getElementById('achievementChart').getContext('2d');
                if (charts.achievement) charts.achievement.destroy();
                
                charts.achievement = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'äºˆç®—é”æˆç‡ (%)',
                            data: achievements,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#28a745',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            },

            createExpenseCharts(data) {
                // ã‚µãƒ³ãƒ—ãƒ«çµŒè²»ãƒ‡ãƒ¼ã‚¿
                const months = data.map(item => item.month);
                const sampleExpenses = {
                    'äººä»¶è²»': [150000, 160000, 155000, 170000, 165000],
                    'å…‰ç†±è²»': [25000, 30000, 28000, 32000, 29000],
                    'é€šä¿¡è²»': [15000, 18000, 16000, 20000, 17000],
                    'äº¤é€šè²»': [12000, 15000, 13000, 16000, 14000],
                    'ãã®ä»–çµŒè²»': [8000, 10000, 9000, 11000, 10000]
                };
                
                // çµŒè²»æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ
                const expenseCtx = document.getElementById('expenseChart').getContext('2d');
                if (charts.expense) charts.expense.destroy();
                
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
                const datasets = Object.keys(sampleExpenses).map((expenseName, index) => ({
                    label: expenseName,
                    data: sampleExpenses[expenseName],
                    borderColor: colors[index],
                    backgroundColor: colors[index] + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4
                }));
                
                charts.expense = new Chart(expenseCtx, {
                    type: 'line',
                    data: { labels: months, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'top' } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'Â¥' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
                
                // çµŒè²»æ§‹æˆæ¯”ãƒãƒ£ãƒ¼ãƒˆ
                const pieCtx = document.getElementById('expensePieChart').getContext('2d');
                if (charts.expensePie) charts.expensePie.destroy();
                
                const pieData = Object.keys(sampleExpenses).map(expenseName => ({
                    label: expenseName,
                    value: sampleExpenses[expenseName].reduce((sum, val) => sum + val, 0)
                }));
                
                charts.expensePie = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: pieData.map(item => item.label),
                        datasets: [{
                            data: pieData.map(item => item.value),
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'bottom' } }
                    }
                });
            },

            createGrossMarginChart(months, margins) {
                const ctx = document.getElementById('grossMarginChart').getContext('2d');
                if (charts.grossMargin) charts.grossMargin.destroy();
                
                charts.grossMargin = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'ç²—åˆ©ç‡ (%)',
                            data: margins,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#28a745',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            },

            createOperatingProfitChart(data) {
                const months = data.map(item => item.month);
                const operatingProfits = data.map(item => {
                    const expenses = item.expenses ? Object.values(item.expenses).reduce((sum, exp) => sum + exp, 0) : 0;
                    return item.profit - expenses;
                });
                
                const operatingMargins = data.map(item => {
                    const expenses = item.expenses ? Object.values(item.expenses).reduce((sum, exp) => sum + exp, 0) : 0;
                    const operatingProfit = item.profit - expenses;
                    return item.revenue > 0 ? ((operatingProfit / item.revenue) * 100).toFixed(1) : 0;
                });
                
                const ctx = document.getElementById('operatingProfitChart').getContext('2d');
                if (charts.operatingProfit) charts.operatingProfit.destroy();
                
                charts.operatingProfit = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'å–¶æ¥­åˆ©ç›Š (å††)',
                            data: operatingProfits,
                            backgroundColor: 'rgba(255, 193, 7, 0.8)',
                            borderColor: '#ffc107',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                            yAxisID: 'y'
                        }, {
                            label: 'å–¶æ¥­åˆ©ç›Šç‡ (%)',
                            data: operatingMargins,
                            type: 'line',
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#dc3545',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'top' } },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                ticks: {
                                    callback: function(value) {
                                        return 'Â¥' + value.toLocaleString();
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }
        };

        // ãƒ¡ãƒ¼ãƒ«å…±æœ‰ã‚µãƒ¼ãƒ“ã‚¹
        const EmailService = {
            shareByEmail() {
                if (!currentData || currentData.length === 0) {
                    MessageUtils.showError('åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                const emailContent = this.generateEmailContent(currentData);
                const subject = encodeURIComponent('ğŸ“Š çµŒå–¶åˆ†æãƒ¬ãƒãƒ¼ãƒˆ');
                const body = encodeURIComponent(emailContent);
                
                const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
                window.open(mailtoLink);
                
                MessageUtils.showSuccess('ãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒé–‹ãã¾ã—ãŸï¼');
            },

            generateEmailContent(data) {
                const totalRevenue = data.reduce((sum, item) => sum + item.revenue, 0);
                const avgMargin = (data.reduce((sum, item) => sum + item.margin, 0) / data.length).toFixed(1);
                
                let content = `ğŸ“Š çµŒå–¶åˆ†æãƒ¬ãƒãƒ¼ãƒˆ\n\n`;
                content += `ğŸ“… åˆ†ææœŸé–“: ${data[0].month} ï½ ${data[data.length-1].month}\n`;
                content += `ğŸ“ˆ åˆ†ææœˆæ•°: ${data.length}ãƒ¶æœˆ\n\n`;
                
                content += `ğŸ’° ã‚µãƒãƒªãƒ¼\n`;
                content += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                content += `ç·å£²ä¸Š: Â¥${totalRevenue.toLocaleString()}\n`;
                content += `å¹³å‡åˆ©ç›Šç‡: ${avgMargin}%\n\n`;
                
                content += `ğŸ“Š æœˆåˆ¥è©³ç´°ãƒ‡ãƒ¼ã‚¿\n`;
                content += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                data.forEach(item => {
                    content += `${item.month}:\n`;
                    content += `  å£²ä¸Š: Â¥${item.revenue.toLocaleString()}\n`;
                    content += `  åˆ©ç›Š: Â¥${item.profit.toLocaleString()}\n`;
                    content += `  åˆ©ç›Šç‡: ${item.margin}%\n`;
                    if (item.budget) {
                        content += `  äºˆç®—: Â¥${item.budget.toLocaleString()}\n`;
                        content += `  äºˆç®—é”æˆç‡: ${item.budgetAchievement}%\n`;
                    }
                    content += `\n`;
                });
                
                content += `ğŸ“ åˆ†ææ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}\n`;
                content += `ğŸ“§ ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯çµŒå–¶åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚\n`;
                
                return content;
            }
        };
    </script>
</body>
</html>